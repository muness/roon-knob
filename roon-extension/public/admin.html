<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roon Knob Bridge Dashboard</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 2rem; background: #0d1117; color: #e6edf3; }
    h1 { margin-top: 0; }
    .section { margin-bottom: 2rem; padding: 1rem; background: #161b22; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { text-align: left; padding: 0.4rem; border-bottom: 1px solid #30363d; }
    th { color: #93ccea; }
    .pill { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.8rem; }
    .pill.online { background: #238636; }
    .pill.offline { background: #da3633; }
    .muted { color: #8b949e; font-size: 0.9rem; }
    code { background: #0d1117; padding: 0.1rem 0.3rem; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>Roon Knob Bridge</h1>
  <div id="status" class="section">Loading…</div>
  <div id="zones" class="section"></div>
  <div id="knobs" class="section"></div>
  <div id="clients" class="section"></div>
  <div id="events" class="section"></div>
  <script>
    const statusEl = document.getElementById('status');
    const zonesEl = document.getElementById('zones');
    const knobsEl = document.getElementById('knobs');
    const clientsEl = document.getElementById('clients');
    const eventsEl = document.getElementById('events');

    function ago(ts) {
      if (!ts) return 'never';
      const diff = Date.now() - ts;
      if (diff < 1000) return 'just now';
      const seconds = Math.floor(diff / 1000);
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    async function refresh() {
      try {
        const resp = await fetch('/admin/status.json');
        const data = await resp.json();
        render(data);
      } catch (err) {
        statusEl.innerHTML = `<div class="pill offline">Error</div> Failed to load status: ${err}`;
      }
    }

    function render({ bridge, metrics }) {
      const connected = bridge.connected;
      const pill = `<span class="pill ${connected ? 'online' : 'offline'}">${connected ? 'Online' : 'Offline'}</span>`;
      statusEl.innerHTML = `
        <h2>Status ${pill}</h2>
        <p>Core: ${bridge.core ? `${bridge.core.name} (${bridge.core.version})` : 'Not paired'} </p>
        <p>Zones tracked: ${bridge.zone_count}</p>
        <p class="muted">Uptime: ${ago(Date.now() - metrics.uptimeMs)}</p>
        <p class="muted">mDNS: ${metrics.mdns ? `${metrics.mdns.name} → ${metrics.mdns.base}` : 'not published'}</p>
      `;

      const rows = bridge.zones.map((zone) => `
        <tr>
          <td>${zone.zone_name}</td>
          <td>${zone.zone_id}</td>
        </tr>
      `).join('');
      zonesEl.innerHTML = `
        <h2>Zones</h2>
        <table>
          <thead><tr><th>Name</th><th>Zone ID</th></tr></thead>
          <tbody>${rows || '<tr><td colspan="2" class="muted">No zones yet</td></tr>'}</tbody>
        </table>
      `;

      const knobRows = (metrics.knobs || []).map((knob) => `
        <tr>
          <td>${knob.id || '(unknown)'}</td>
          <td>${knob.ip || ''}</td>
          <td>${knob.version || ''}</td>
          <td>${knob.last_zone || ''}</td>
          <td>${ago(knob.last_seen)}</td>
        </tr>
      `).join('');
      knobsEl.innerHTML = `
        <h2>Knob Clients</h2>
        <table>
          <thead><tr><th>ID</th><th>IP</th><th>Version</th><th>Last Zone</th><th>Seen</th></tr></thead>
          <tbody>${knobRows || '<tr><td colspan="5" class="muted">No devices yet</td></tr>'}</tbody>
        </table>
      `;

      const clientRows = (metrics.clients || []).map((client) => `
        <tr>
          <td>${client.ip}</td>
          <td>${ago(client.last_seen)}</td>
        </tr>
      `).join('');
      clientsEl.innerHTML = `
        <h2>Recent Clients</h2>
        <table>
          <thead><tr><th>IP</th><th>Last Seen</th></tr></thead>
          <tbody>${clientRows || '<tr><td colspan="2" class="muted">No activity yet</td></tr>'}</tbody>
        </table>
      `;

      const events = (metrics.recentEvents || []).slice(0, 10).map((event) => `
        <tr>
          <td>${event.type}</td>
          <td>${event.zone_id || ''}</td>
          <td>${event.ip || ''}</td>
          <td>${ago(event.timestamp)}</td>
        </tr>
      `).join('');
      eventsEl.innerHTML = `
        <h2>Recent Activity</h2>
        <table>
          <thead><tr><th>Type</th><th>Zone</th><th>Client</th><th>When</th></tr></thead>
          <tbody>${events || '<tr><td colspan="4" class="muted">No events yet</td></tr>'}</tbody>
        </table>
      `;
    }

    refresh();
    setInterval(refresh, 4000);
  </script>
</body>
</html>
