name: Build and Release

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-idf:
    name: build-idf
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag or CMakeLists
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(grep 'set(PROJECT_VER' esp_dial/CMakeLists.txt | sed 's/.*"\(.*\)".*/\1/')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building firmware version: $VERSION"

      - name: Inject version into CMakeLists.txt
        run: |
          sed -i 's/set(PROJECT_VER ".*")/set(PROJECT_VER "${{ steps.version.outputs.version }}")/' esp_dial/CMakeLists.txt
          grep PROJECT_VER esp_dial/CMakeLists.txt

      - name: Build with ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: release-v5.5
          target: esp32s3
          path: esp_dial

      - name: Create merged flash image for web flashing
        run: |
          pip install esptool
          esptool --chip esp32s3 merge-bin \
            -o roon_knob_merged.bin \
            --flash-mode dio --flash-freq 80m --flash-size 16MB \
            0x0 esp_dial/build/bootloader/bootloader.bin \
            0x8000 esp_dial/build/partition_table/partition-table.bin \
            0xd000 esp_dial/build/ota_data_initial.bin \
            0x10000 esp_dial/build/roon_knob.bin
          ls -la *.bin

      - name: Upload ESP32-S3 artifact
        uses: actions/upload-artifact@v4
        with:
          name: esp32s3-firmware
          path: |
            esp_dial/build/roon_knob.bin
            roon_knob_merged.bin
          retention-days: 30

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-idf]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download ESP32-S3 firmware
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware
          path: esp32s3-artifacts

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Get release notes from draft
        id: notes
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Try to get draft release body (maintained by release-drafter)
          DRAFT_BODY=$(gh api repos/${{ github.repository }}/releases \
            --jq '.[] | select(.draft == true) | .body' 2>/dev/null | head -1 || echo "")

          # Check if draft has actual PR content (not just empty template)
          if [ -n "$DRAFT_BODY" ] && echo "$DRAFT_BODY" | grep -q "github.com.*pull"; then
            echo "$DRAFT_BODY" > release_notes.md
            echo "Using draft release notes from release-drafter"
          else
            # Fallback: generate notes via GitHub API
            echo "Draft empty or no PRs, generating from GitHub API..."
            # Get previous tag via GitHub API (more reliable than git in shallow clones)
            PREV_TAG=$(gh api repos/${{ github.repository }}/tags --jq '.[].name' | grep '^v' | sort -V | grep -B1 "^${{ github.ref_name }}$" | head -1)
            if [ "$PREV_TAG" = "${{ github.ref_name }}" ]; then
              # Current tag is oldest, no previous
              PREV_TAG=""
            fi
            echo "Previous tag: $PREV_TAG"
            if [ -n "$PREV_TAG" ]; then
              gh api repos/${{ github.repository }}/releases/generate-notes \
                -f tag_name="${{ github.ref_name }}" \
                -f previous_tag_name="$PREV_TAG" \
                --jq '.body' > release_notes.md 2>/dev/null || echo "## What's Changed" > release_notes.md
            else
              echo "## What's Changed" > release_notes.md
            fi
            echo "Generated release notes"
          fi
          echo "--- Release notes content ---"
          cat release_notes.md

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          cp esp32s3-artifacts/esp_dial/build/roon_knob.bin release-assets/
          cp esp32s3-artifacts/roon_knob_merged.bin release-assets/
          ls -la release-assets/

      - name: Build release body
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Start with auto-generated "What's Changed"
          cat release_notes.md > final_body.md

          # Append template with version substituted
          sed "s/{{VERSION}}/$VERSION/g" .github/RELEASE_TEMPLATE.md >> final_body.md

      - name: Check if release exists
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_EXISTS=$(gh release view ${{ github.ref_name }} --json assets --jq '.assets | length' 2>/dev/null || echo "0")
          echo "existing_assets=$RELEASE_EXISTS" >> $GITHUB_OUTPUT
          if [ "$RELEASE_EXISTS" -gt "0" ]; then
            echo "Release already exists with $RELEASE_EXISTS assets, will only upload missing files"
          fi

      - name: Create or Update Release
        if: steps.check_release.outputs.existing_assets == '0'
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          files: |
            release-assets/roon_knob.bin
            release-assets/roon_knob_merged.bin
          body_path: final_body.md

      - name: Upload assets to existing release
        if: steps.check_release.outputs.existing_assets != '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Upload any missing assets
          for file in release-assets/*; do
            filename=$(basename "$file")
            if ! gh release view ${{ github.ref_name }} --json assets --jq ".assets[].name" | grep -q "^${filename}$"; then
              echo "Uploading $filename..."
              gh release upload ${{ github.ref_name }} "$file" --clobber
            else
              echo "$filename already exists, skipping"
            fi
          done

  # NOTE: Docker builds moved to unified-hifi-control repo
  # The muness/unified-hifi-control and muness/roon-extension-knob images
  # are now built from https://github.com/cloud-atlas-ai/unified-hifi-control

  deploy-pr-preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    needs: [build-idf]
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Download ESP32-S3 firmware
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware
          path: esp32s3-artifacts

      - name: Prepare PR preview content
        env:
          PR_NUM: ${{ github.event.pull_request.number }}
        run: |
          mkdir -p pr-preview

          # Copy firmware
          cp esp32s3-artifacts/roon_knob_merged.bin pr-preview/

          # Create PR-specific manifest
          cat > pr-preview/manifest-s3.json << EOF
          {
            "name": "Roon Knob (PR #${PR_NUM} Preview)",
            "version": "pr-${PR_NUM}",
            "new_install_prompt_erase": true,
            "builds": [{
              "chipFamily": "ESP32-S3",
              "parts": [{
                "path": "roon_knob_merged.bin",
                "offset": 0
              }]
            }]
          }
          EOF

          # Create PR flash page from template
          sed "s/{{PR_NUMBER}}/${PR_NUM}/g" web/flash-pr.html > pr-preview/flash.html

          echo "PR preview contents:"
          ls -la pr-preview/

      - name: Deploy PR preview to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./pr-preview
          destination_dir: pr/${{ github.event.pull_request.number }}
          keep_files: true

      - name: Post preview URL to PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://roon-knob.muness.com/pr/${prNumber}/flash.html`;

            // Check if we already posted a comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Firmware Preview')
            );

            const body = `### Firmware Preview

            Flash this PR's firmware directly in your browser:
            **${previewUrl}**

            _Updated: ${new Date().toISOString()}_`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [release]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download ESP32-S3 firmware
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware
          path: esp32s3-artifacts

      - name: Prepare gh-pages content
        run: |
          mkdir -p gh-pages-build
          cp web/index.html gh-pages-build/
          cp web/flash.html gh-pages-build/
          cp web/manifest-s3.json gh-pages-build/
          cp esp32s3-artifacts/roon_knob_merged.bin gh-pages-build/
          echo "roon-knob.muness.com" > gh-pages-build/CNAME
          ls -la gh-pages-build/

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages-build
