name: CI

on:
  push: {}
  pull_request: {}

jobs:
  build-pc:
    name: Build PC Simulator
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          brew install cmake ninja sdl2 curl
      - name: Configure & build
        run: |
          cmake -S pc_sim -B build/pc_sim -G Ninja
          cmake --build build/pc_sim
      - name: JSON unit test
        run: python tests/test_json_parse.py

  build-esp32s3:
    name: Build ESP32-S3 Firmware
    runs-on: ubuntu-latest
    container: espressif/idf:v5.4.1
    steps:
      - uses: actions/checkout@v4
      - name: Build ESP32-S3 firmware
        working-directory: idf_app
        run: |
          . $IDF_PATH/export.sh
          idf.py set-target esp32s3
          idf.py build
      - name: Upload ESP32-S3 binary
        uses: actions/upload-artifact@v4
        with:
          name: esp32s3-firmware
          path: idf_app/build/roon_knob.bin

  build-esp32bt:
    name: Build ESP32 Bluetooth Firmware
    runs-on: ubuntu-latest
    container: espressif/idf:v5.4.1
    steps:
      - uses: actions/checkout@v4
      - name: Build ESP32 BT firmware
        working-directory: esp32_bt
        run: |
          . $IDF_PATH/export.sh
          idf.py set-target esp32
          idf.py build
      - name: Upload ESP32 BT binary
        uses: actions/upload-artifact@v4
        with:
          name: esp32bt-firmware
          path: esp32_bt/build/esp32_bt.bin

  release:
    name: Create Release
    needs: [build-esp32s3, build-esp32bt]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download ESP32-S3 firmware
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware
          path: release-assets

      - name: Download ESP32 BT firmware
        uses: actions/download-artifact@v4
        with:
          name: esp32bt-firmware
          path: release-assets

      - name: Rename binaries for clarity
        run: |
          mv release-assets/roon_knob.bin "release-assets/roon_knob_esp32s3.bin"
          mv release-assets/esp32_bt.bin "release-assets/roon_knob_esp32_bluetooth.bin"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            release-assets/roon_knob_esp32s3.bin
            release-assets/roon_knob_esp32_bluetooth.bin
          body: |
            ## Flashing Instructions

            This release includes **two firmware files** for the dual-chip board:

            | File | Chip | USB Orientation | Port (macOS) |
            |------|------|-----------------|--------------|
            | `roon_knob_esp32s3.bin` | ESP32-S3 (main) | Normal | `/dev/cu.usbmodem*` |
            | `roon_knob_esp32_bluetooth.bin` | ESP32 (Bluetooth) | Flipped 180° | `/dev/cu.usbserial-*` |

            ### Identifying the correct port

            The two chips appear as **different USB devices**:
            - **ESP32-S3**: Shows as `usbmodem` (native USB)
            - **ESP32**: Shows as `usbserial` (USB-UART bridge)

            ```bash
            # List ports (macOS)
            ls /dev/cu.usb*

            # List ports (Linux)
            ls /dev/ttyUSB* /dev/ttyACM*
            ```

            ### First-time setup (both chips required)

            1. **Flash ESP32-S3** (USB-C in normal orientation):
               ```bash
               esptool.py --chip esp32s3 -p /dev/cu.usbmodem2101 write_flash 0x0 roon_knob_esp32s3.bin
               ```

            2. **Flip USB-C connector 180°** (physically rotate the cable)

            3. **Flash ESP32** (USB-C now flipped):
               ```bash
               esptool.py --chip esp32 -p /dev/cu.usbserial-210 write_flash 0x0 roon_knob_esp32_bluetooth.bin
               ```

            ### Routine updates (ESP32-S3 only)

            For most updates, only the ESP32-S3 firmware changes. The Bluetooth firmware rarely needs updating.

            ---
